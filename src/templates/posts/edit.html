{% extends "base.html" %}
{% block content %}
<div class="edit-post container">Edit Post</h1>
    <h4 class="error hidden"></h4>
    <div class="page-form">
    <div class="overlay hidden"></div>
    <form id="create-post-form">
        <div class="form-group">
            <label for="title">Title</label>
            <input id="title" class="form-control" name="title" value="{{ post['title'] }}">
        </div>
        <div class="form-group">
            <label for="description">Description</label>
            <textarea id="description" class="form-control" name="description">{{ post['description'] }}</textarea>
        </div>
        <div class="form-group paragraphs">
            <label for="body">Body</label>
            <textarea id="body" class="form-control" name="body">{{ '\n\n'.join(post['body'].split(',')) }}</textarea>
        </div>
        <div class="form-group">
            <label for="tag">Tag</label>
            <select id="tag" class="form-control" name="tag">
                <option value="0"></option>
                {% for tag in tags %}
                    {% if tag == post['tag'] %}
                        <option value="{{ tag }}" selected>{{ tag }}</option>
                    {% else %}
                        <option value="{{ tag }}">{{ tag }}</option>
                    {% endif %}
                {% endfor %}
            </select>
        </div>
        <button type="submit" class="btn btn-success update disabled">Update</button>
    </form>
</div>

</div>
<script type="text/javascript">
    $(document).ready(function() {
        var numParagraphs = 1;
        var paragraphs = '';
        var canUpdate = false;
        $("input, textarea").keyup(function(){
            var post = {
                "title": "{{post['title']}}",
                "description": "{{post['description']}}",
                "body": "{{post['body']}}",
                "tag": "{{post['tag']}}",
            };

            $('.paragraphs').find('.paragraph').each(function(index) {
                if (index == 0) {
                    paragraphs = $(this).find('textarea').val();
                } else {
                    paragraphs += ","+$(this).find('textarea').val();
                }
            });

            if (post['title'] !== $('#title').val() || post['description'] !== $('#description').val() || post['tag'] !== $('#tag').val() || post['body'] !== paragraphs) {
                $('button.update').removeClass('disabled');
                canUpdate = true;
            } else {
                $('button.update').addClass('disabled');
                canUpdate = false;
            }
        });
        $('select').change(function(e) {
            var post = {
                "title": "{{post['title']}}",
                "description": "{{post['description']}}",
                "body": "{{post['body']}}",
                "tag": "{{post['tag']}}",
            };

            paragraphs = $(".paragraph textArea").val().replace(/\n\s*\n/g, ',');

            if (post['title'] !== $('#title').val() || post['description'] !== $('#description').val() || post['tag'] !== $('#tag').val() || post['body'] !== paragraphs) {
                $('button.update').removeClass('disabled');
                canUpdate = true;
            } else {
                $('button.update').addClass('disabled');
                canUpdate = false;
            }
        });
        $('button.btn-success').click(function(e) {
            e.preventDefault();
            $('.error').addClass('hidden');
            $('.error').text('');
            paragraphs = $(".paragraphs textArea").val().replace(/\n\s*\n/g, '\n').split("\n");
            if (canUpdate && paragraphs && $('select').val()) {
                $.ajax({
                    url: '{{ url_for('posts.update', id=post['_id']) }}',
                    data: "title="+$('input#title').val()+"&description="+$('textarea#description').val()+"&body="+paragraphs+"&tag="+$('select#tag').val(),
                    type: 'POST',
                    beforeSend: function() {
                        $('.overlay').removeClass('hidden');
                    },
                    success: function(response) {
                        if (response.status === 'OK') {
                            window.location.href = "{{ url_for('posts.all') }}";
                        } else {
                            $('.error').removeClass('hidden');
                            $('.error').text('Could not create post');
                        }
                    },
                    error: function(error) {
                        $('.error').removeClass('hidden');
                        $('.error').text(error);
                    },
                    complete: function() {
                        $('.overlay').addClass('hidden');
                    }
                });
            } else {
                $('.error').removeClass('hidden');
                $('.error').text('Error: Body and tag are required');
            }
        });
    });
</script>
{% endblock %}