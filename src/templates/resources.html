{% extends "base.html" %}
{% block content %}

<div class="resources">

    <h4 class="error hidden"></h4>
    <div class="page-form">
        <div class="container">
            <div class="overlay hidden"></div>
        <form id="search-posts">
            <!--<div class="form-group">-->
                <!--<label for="input-tag">Search</label>-->
                <!--<input type="text" id="input-tag" class="form-control" name="input-tag">-->
            <!--</div>-->
            <div class="form-group tag-search">
                <label for="select-tag">Filter by category</label>
                <select id="select-tag" class="form-control" name="select-tag">
                    <option value="0"></option>
                    {% for tag in tags %}
                        <option value="{{ tag }}">{{ tag }}</option>
                    {% endfor %}
                </select>
            </div>
            <!--<button type="submit" class="btn btn-success">Search</button>-->
        </form>
        </div>
    </div>
    <div class="posts">
        <div class="container">
            {% for post in posts %}
                <div class="post">
                    <a href="{{ url_for('resource', id=post['_id']) }}">
                        <div class="content">
                            <div class="title"><h4>{{ post['title'] }}</h4></div>
                            <div class="description">{{ post['description'] }}</div>
                        </div>
                    </a>
                </div>
        {% endfor %}
        </div>
    </div>

</div>


<script type="text/javascript">
    var renderPosts = function(posts) {
        $('.posts .container').empty();
        var postDiv;
        var content;
        var title;
        var description;
        var contentContainer;
        posts.forEach((post) => {
            postDiv = $('<div>').addClass('post');
            contentContainer = $('<a>').attr('href', '/resource/'+post['_id'])
            content = $('<div>').addClass('content');
            title = $('<div>').addClass('title').html('<h4>'+post['body']+'</h4>');
            description = $('<div>').addClass('description').html(post['description']);
            title.appendTo(content);
            description.appendTo(content);
            content.appendTo(contentContainer);
            contentContainer.appendTo(postDiv);
            postDiv.appendTo($('.posts .container'));
        });
    }

    $(document).ready(function() {
        $('button').click(function(e) {
            e.preventDefault();
            $('.error').addClass('hidden');
            $('.error').text('');
            $('select').val('0');
            if($('input').val()) {
                $.ajax({
                    url: '{{ url_for('posts.search') }}',
                    data: "input-tag="+$('input').val(),
                    type: 'POST',
                    beforeSend: function() {
                        $('.overlay').removeClass('hidden');
                    },
                    success: function(response) {
                        if (response.status === 'OK') {
                            console.log(response);
                            renderPosts(response.posts);
                        } else {
                            $('.error').removeClass('hidden');
                            $('.error').text('Could not complete search');
                        }
                    },
                    error: function(error) {
                        $('.error').removeClass('hidden');
                        $('.error').text(error);
                    },
                    complete: function() {
                        $('.overlay').addClass('hidden');
                    }
                });
            } else if ($('select').val() === "0") {
                $('.error').removeClass('hidden');
                $('.error').text('Error: no tag selected');
            }

        });

        $('select').on('change', function(e) {
            e.preventDefault();
            $('.error').addClass('hidden');
            $('.error').text('');
            if ($(this).val()) {
                $('input').val('');
                $.ajax({
                    url: '{{ url_for('posts.search') }}',
                    data: "select-tag="+$('select').val(),
                    type: 'POST',
                    beforeSend: function() {
                        $('.overlay').removeClass('hidden');
                    },
                    success: function(response) {
                        if (response.status === 'OK') {
                            console.log(response);
                            renderPosts(response.posts);
                        } else {
                            $('.error').removeClass('hidden');
                            $('.error').text('Could not create post');
                        }
                    },
                    error: function(error) {
                        $('.error').removeClass('hidden');
                        $('.error').text(error);
                    },
                    complete: function() {
                        $('.overlay').addClass('hidden');
                    }
                });
            } else if ($('input').val() === "") {
                $('.error').removeClass('hidden');
                $('.error').text('Error: no tag selected');
            }
        });
    });
</script>
{% endblock %}